#Helper function for PSVulnCheck

Function Test-Vulnerability {
    [CmdletBinding()]
    param (
        [Parameter(Mandatory)]
        [string[]]  $computerName,
        [string[]]  $KB,
        [string]    $TargetFile,
        [hashtable] $fileVersions,
        [hashtable[]] $Services,
        [string]    $logfile
    )

    if (! $logfile ) {$logfile = "$env:USERPROFILE\$($MyInvocation.MyCommand)-InvokeParallel.log"}

    if ($computerName) {
        $computerName | Invoke-Parallel -LogFile $logFile -RunspaceTimeout 600 {
            $computerName      = $_
            $iKB               = $using:KB
            $iFileVersions     = $using:fileversions
            $iTargetFile       = $using:TargetFile
            $iServices         = $using:Services

            $scriptblockGetOsVersion = {
                try   { $ver = (Get-CimInstance win32_operatingsystem).version }
                catch { $ver = (Get-WmiObject win32_operatingsystem).version }

                if     ($ver -match [version] '6.1')        { Write-Output 'Win6_1'}
                elseif ($ver -match [version] '6.2')        { Write-Output 'Win6_2'}
                elseif ($ver -match [version] '6.3')        { Write-Output 'Win6_3'}
                elseif ($ver -match [version] '10.0.10240') { Write-Output 'Win10_10240'}
                elseif ($ver -match [version] '10.0.10586') { Write-Output 'Win10_10586'}
                elseif ($ver -match [version] '10.0.14393') { Write-Output 'Win10_14393'}
                elseif ($ver -match [version] '10.0.15063') { Write-Output 'Win10_15063'}
                else                                        { Write-Output [string]$ver}
            }

            $output = [PSCustomObject]@{ComputerName = $computerName}
			
            #check for proper file version
            if ($iFileVersions -and $iTargetFile) {
                try {
                    $status            = 'Connected'
                    $osVersion         = Invoke-Command -computername $computerName -ErrorAction Stop -scriptblock $scriptblockGetOsVersion
                    $targetFileVersion = [version] $iFileVersions.$OSVersion
                    $pulledFileVersion = Invoke-Command -computername $computerName -ErrorAction Stop -scriptblock { param ([string]$file); (Get-Item -Path $file).VersionInfo } -ArgumentList $iTargetFile
                    $actualFileVersion = [version]("{0}.{1}.{2}.{3}" -f $pulledFileVersion.FileMajorPart, $pulledFileVersion.FileMinorPart, $pulledFileVersion.FileBuildPart, $pulledFileVersion.FilePrivatePart)
                    $fileVersionOK     = $actualFileVersion -ge [version]$targetFileVersion
                    $fileCheckErrors   = $null
                } catch [System.Management.Automation.Remoting.PSRemotingTransportException] {
                    $status            = 'Disconnected'
                    $osVersion         = $null
                    $actualFileVersion = $null
                    $fileVersionOK     = $null
                    $fileCheckErrors   = $_.exception.TransportMessage
                } catch {
                    $status            = 'Unknown'
                    $osVersion         = $null
                    $actualFileVersion = $null
                    $fileVersionOK     = $null
                    $fileCheckErrors   = $_.exception                     
                } finally {
                    $output | Add-Member -MemberType NoteProperty -Name 'OSVersion'         -value $osVersion
                    $output | Add-Member -MemberType NoteProperty -Name 'Status'            -value $status
                    $output | Add-Member -MemberType NoteProperty -Name 'FileVersionOk'     -value $fileVersionOK
                    $output | Add-Member -MemberType NoteProperty -Name 'TargetFile'        -value $iTargetFile
                    $output | Add-Member -MemberType NoteProperty -Name 'TargetFileVersion' -value $targetFileVersion
                    $output | Add-Member -MemberType NoteProperty -Name 'ActualFileVersion' -Value $actualFileVersion
                    $output | Add-Member -MemberType NoteProperty -Name 'FileCheckErrors'   -value $fileCheckErrors
                }
            }

			$patched, $installedKBs, $thisError = $null, $null, $null
            #check for any hotfixes which may be installed
            if ($iKB) {
                try {
                    $hotfixes     = Get-Hotfix -Id $iKB -ComputerName $computerName -ErrorAction Stop
                    $thisError    = $null
                    if ($hotfixes) {
                        $patched      = $true
                        $installedKBs = $hotfixes.HotFixID
                    } else {
                        $patched      = $false
                        $installedKBs = $null
                    }
                } catch [System.ArgumentException] {
                    $thisError    = $_.exception
                    $patched      = $false
					$installedKBs = $false
                } catch {
                    $thisError    = $_.exception
                    $patched      = $false
					$installedKBs = $false
                } finally {
                    $output | Add-Member -MemberType NoteProperty -Name 'Patched'      -Value $patched
                    $output | Add-Member -MemberType NoteProperty -Name 'InstalledKBs' -Value $installedKBs
                    $output | Add-Member -MemberType NoteProperty -Name 'KBErrors'     -Value $kbErrors
                }
            }

            $Script:ServiceErrors = @()
            $servicesOK = $true
            if ($iServices) {
                $iServices | ForEach-Object {
                    $state,$presence = $null,$null
                    $InTargetPresence,$InTargetState,$InTargetStartType = $true, $true, $true
                    $serviceDefinition = $_
                    try {
                        $serviceState = (Get-Service -ComputerName $computerName -Name $serviceDefinition.name -ErrorAction Stop)
                        $presence = 'Present'

                        if ($serviceDefinition.TargetState) { $InTargetState = ($serviceDefinition.TargetState -eq $serviceState.status) }
                        if ($serviceDefinition.TargetStartType) { $InTargetStartType = ($serviceDefinition.TargetStartType -eq $serviceState.status) }

                        #add Target State
                        if ($serviceDefinition.TargetState) {
                            $output | Add-Member -MemberType NoteProperty -Name "$($serviceDefinition.name)_TargetState" -Value $serviceDefinition.TargetState
                            $output | Add-Member -MemberType NoteProperty -Name "$($serviceDefinition.name)_State" -Value $serviceState.Status

                            $InTargetState = $serviceDefinition.TargetState -eq $serviceState.Status
                        }
                        
                        #add Target Start State
                        if ($serviceDefinition.TargetStartType) {
                            $output | Add-Member -MemberType NoteProperty -Name "$($serviceDefinition.name)_TargetStartType" -Value $serviceDefinition.TargetStartType
                            $output | Add-Member -MemberType NoteProperty -Name "$($serviceDefinition.name)_StartType" -Value $serviceState.StartType

                            $InTargetStartType = $serviceDefinition.TargetStartType -eq $serviceState.StartType
                        }
                    } catch {
                        if ($_.exception.message -match "Cannot find any service with service name '$($serviceDefinition.name)'.") {
                            $presence = 'Absent'
                        } else {
                            $Script:ServiceErrors += $_.exception.messages
                        }
                    } finally {
                        #add Target Presence
                        if ($serviceDefinition.TargetPresence) {
                            $InTargetPresence = ($serviceDefinition.TargetPresence -eq $presence)
                            $output | Add-Member -MemberType NoteProperty -Name "$($serviceDefinition.name)_TargetPresence" -Value $serviceDefinition.TargetPresence
                            $output | Add-Member -MemberType NoteProperty -Name "$($serviceDefinition.name)_Presence" -Value $presence
                        }

                        $thisServiceOK = $InTargetPresence -and $InTargetState -and $InTargetStartType

                        #update ServicesOK with this Service's information
                        $servicesOK = $servicesOK -and $thisServiceOK
                    }
                }
                
                #Add boolean checking for any service vulnerable
                $output | Add-Member -MemberType NoteProperty -Name ServicesOK -Value $servicesOK 
                
                #Add any errors if they were presents
                if ($Script:ServiceErrors -ne @()) { $output | Add-Member -MemberType NoteProperty -Name ServicesErrors -Value $Script:ServiceErrors }
            }

            Write-Output $output
        }

        remove-item -Path $logfile
    } else {
        Write-Warning "Parameter -computerName could name be validated.  Value was:$computername"
    }
}
